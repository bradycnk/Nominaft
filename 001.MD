-- 1. Actualizar tabla de empleados
ALTER TABLE empleados 
ADD COLUMN IF NOT EXISTS rif TEXT,
ADD COLUMN IF NOT EXISTS cv_url TEXT;

-- 2. Crear bucket de storage (Forma segura vía SQL)
INSERT INTO storage.buckets (id, name, public)
SELECT 'expedientes', 'expedientes', false
WHERE NOT EXISTS (
    SELECT 1 FROM storage.buckets WHERE id = 'expedientes'
);

-- 3. Políticas de Seguridad (Ajustadas)
-- NOTA: Se recomienda usar una condición para verificar si el usuario es realmente ADMIN
-- Ejemplo: auth.jwt() -> 'role' = 'service_role' o una tabla de perfiles.

-- Política de Inserción
CREATE POLICY "Admins pueden subir expedientes" 
ON storage.objects FOR INSERT 
TO authenticated 
WITH CHECK (bucket_id = 'expedientes');

-- Política de Lectura
CREATE POLICY "Admins pueden ver expedientes" 
ON storage.objects FOR SELECT 
TO authenticated 
USING (bucket_id = 'expedientes');

-- Política de Gestión (Delete/Update)
CREATE POLICY "Admins pueden gestionar expedientes" 
ON storage.objects FOR ALL 
TO authenticated 
USING (bucket_id = 'expedientes');