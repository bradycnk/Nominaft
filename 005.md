
-- 1. Expansión de la tabla empleados para cumplimiento legal completo
ALTER TABLE empleados 
ADD COLUMN IF NOT EXISTS fecha_nacimiento DATE,
ADD COLUMN IF NOT EXISTS lugar_nacimiento TEXT,
ADD COLUMN IF NOT EXISTS nacionalidad TEXT DEFAULT 'Venezolana',
ADD COLUMN IF NOT EXISTS sexo TEXT CHECK (sexo IN ('M', 'F', 'Otro')),
ADD COLUMN IF NOT EXISTS estado_civil TEXT CHECK (estado_civil IN ('Soltero', 'Casado', 'Divorciado', 'Viudo', 'Concubinato')),
ADD COLUMN IF NOT EXISTS direccion_habitacion TEXT,
ADD COLUMN IF NOT EXISTS telefono_movil TEXT,
ADD COLUMN IF NOT EXISTS telefono_fijo TEXT,
ADD COLUMN IF NOT EXISTS email_personal TEXT,
ADD COLUMN IF NOT EXISTS contacto_emergencia_nombre TEXT,
ADD COLUMN IF NOT EXISTS contacto_emergencia_telefono TEXT,
ADD COLUMN IF NOT EXISTS tipo_contrato TEXT DEFAULT 'Indeterminado',
ADD COLUMN IF NOT EXISTS departamento TEXT,
ADD COLUMN IF NOT EXISTS tipo_jornada TEXT DEFAULT 'Tiempo Completo',
ADD COLUMN IF NOT EXISTS salario_base_vef NUMERIC(15, 2) DEFAULT 0.00,
ADD COLUMN IF NOT EXISTS bono_alimentacion_frecuencia TEXT DEFAULT 'Mensual';

-- 2. Tabla para Cargas Familiares (Hijos y Cónyuge)
CREATE TABLE IF NOT EXISTS cargas_familiares (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    empleado_id UUID REFERENCES empleados(id) ON DELETE CASCADE,
    nombre_completo TEXT NOT NULL,
    parentesco TEXT CHECK (parentesco IN ('Hijo', 'Hija', 'Cónyuge', 'Padre', 'Madre')),
    fecha_nacimiento DATE,
    es_menor BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Habilitar RLS en cargas familiares
ALTER TABLE cargas_familiares ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Admin manage family" ON cargas_familiares 
    FOR ALL TO authenticated USING (EXISTS (SELECT 1 FROM perfiles_admin WHERE id = auth.uid()));

-- 4. Índices para rendimiento
CREATE INDEX IF NOT EXISTS idx_cargas_empleado ON cargas_familiares(empleado_id);
