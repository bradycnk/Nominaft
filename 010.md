
-- 1. Optimización para la Vista de Calendario (Sábana de Asistencia)
-- Esto hace que la carga del historial mensual sea instantánea, incluso con años de datos.
CREATE INDEX IF NOT EXISTS idx_asistencias_consulta_calendario 
ON asistencias(empleado_id, fecha DESC);

-- 2. Campo de "Cierre de Nómina" (Inmutabilidad LOTTT)
-- Permite bloquear registros para que no sean modificados después de pagar la quincena.
ALTER TABLE asistencias 
ADD COLUMN IF NOT EXISTS cerrado BOOLEAN DEFAULT FALSE;

-- 3. Restricción de Integridad
-- Asegura que no existan horas de salida anteriores a la entrada (Error humano común)
ALTER TABLE asistencias 
ADD CONSTRAINT check_horas_logicas 
CHECK (hora_salida IS NULL OR hora_salida >= hora_entrada);

-- 4. Comentarios para documentación del sistema
COMMENT ON COLUMN asistencias.cerrado IS 'Bloqueo administrativo: Si es TRUE, el registro ya fue pagado y no debe editarse.';
COMMENT ON INDEX idx_asistencias_consulta_calendario IS 'Índice compuesto para optimizar la generación de reportes mensuales por empleado.';
