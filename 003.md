
-- 1. Ampliar la tabla de asistencias para control horario
ALTER TABLE asistencias 
ADD COLUMN IF NOT EXISTS hora_entrada TIME,
ADD COLUMN IF NOT EXISTS hora_salida TIME;

-- 2. Asegurar que el estado incluya 'inasistencia' como alias de 'falta' para claridad
-- El check ya existe, pero podemos optimizar la visualización

-- 3. Función para marcar faltas automáticas (Lógica de las 4:00 PM)
-- Esta consulta puede ser ejecutada por un Cron Job o invocada por el frontend
-- Aquí definimos la lógica que el frontend usará para "limpiar" el día
CREATE OR REPLACE FUNCTION marcar_inasistencias_del_dia()
RETURNS void AS $$
BEGIN
    -- Insertar registros de 'falta' para empleados activos que no tienen registro hoy
    -- y ya pasaron las 16:00:00
    INSERT INTO asistencias (empleado_id, fecha, estado, observaciones)
    SELECT e.id, CURRENT_DATE, 'falta', 'Marcado automáticamente por sistema (Después de las 16:00)'
    FROM empleados e
    WHERE e.activo = TRUE
    AND NOT EXISTS (
        SELECT 1 FROM asistencias a 
        WHERE a.empleado_id = e.id 
        AND a.fecha = CURRENT_DATE
    )
    AND CURRENT_TIME > '16:00:00'::TIME;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
